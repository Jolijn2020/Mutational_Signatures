mutations = 96
k = 20;  % Number of components in the dictionary
%https://doi.org/10.1093/bioinformatics/btw572

data = [
16,354,64,235,99,154,15,268,14,8,15,13,100,32,216,1556,68,108,199,129,25,25,1311,30,1213,17,10,42,10,357;
44,114,53,137,50,84,36,155,33,14,25,15,44,35,97,876,50,40,71,81,18,82,420,25,574,22,7,29,12,283;
10,28,30,53,14,32,12,63,14,11,23,12,10,12,21,319,26,20,19,43,13,15,74,23,195,12,12,7,7,142;
29,154,49,135,59,82,31,157,28,15,19,11,57,17,117,893,44,48,91,80,19,60,549,28,624,13,14,18,9,261;
40,22,14,37,30,25,37,44,37,7,36,16,16,34,47,219,19,14,20,19,10,95,66,13,102,19,16,32,12,70;
27,25,13,19,22,24,19,26,21,13,16,7,15,20,33,132,10,17,25,15,6,44,87,10,75,10,12,20,9,39;
20,23,7,18,18,15,14,21,21,12,15,5,14,7,28,78,10,15,20,14,12,33,60,9,54,5,9,8,6,22;
49,40,14,29,47,30,50,40,46,16,40,14,24,27,66,220,19,16,30,18,15,119,124,13,103,15,15,20,17,41;
487,71,23,53,64,114,58,72,55,11,274,796,35,2829,418,406,65,28,421,31,57,710,1784,46,238,1081,15,2741,61,82;
192,199,13,33,46,60,161,43,156,504,112,455,24,1018,174,223,32,29,160,40,32,299,678,15,418,684,70,982,31,42;
842,91,8,37,51,175,39,54,36,7,466,1488,37,5288,699,264,94,40,764,23,87,1133,3207,56,201,2019,11,5121,97,15;
196,130,12,39,56,57,93,53,92,212,115,340,33,947,183,290,32,22,160,34,26,303,721,24,297,490,33,915,27,45;
91,43,23,37,76,36,102,60,86,68,67,29,26,9,91,369,22,18,22,36,14,223,77,19,166,42,16,14,18,86;
30,19,18,19,27,15,35,28,28,29,21,22,11,42,31,122,12,10,11,11,12,58,50,9,67,28,7,34,11,36;
26,31,24,55,30,33,36,64,21,26,22,16,15,8,35,295,18,19,10,37,12,54,72,16,175,22,12,7,11,108;
143,95,19,37,108,50,148,68,142,110,102,70,48,83,151,433,25,22,45,27,14,333,246,17,230,103,24,78,27,47;
157,25,21,32,106,45,136,70,124,27,103,44,33,108,136,426,23,11,36,30,19,367,115,22,125,58,5,103,25,74;
88,23,5,9,58,29,75,33,62,10,55,26,25,60,76,177,11,16,26,11,10,191,91,14,51,36,5,56,21,22;
129,23,17,31,80,38,103,54,89,14,90,64,36,200,116,300,24,13,47,19,10,280,162,16,90,81,16,193,18,58;
198,43,12,28,144,45,198,73,171,22,139,22,56,32,186,457,25,18,28,15,11,496,122,23,100,28,10,31,25,24;
296,22,8,9,221,49,296,89,257,17,208,12,69,13,258,588,31,14,17,13,10,762,34,17,40,15,12,6,47,18;
55,18,10,11,42,16,53,27,50,15,40,19,18,21,50,111,13,15,13,8,10,126,42,10,30,19,10,21,16,10;
45,22,12,17,38,16,46,30,38,20,35,17,15,16,43,127,13,16,14,14,6,95,61,4,56,17,13,12,11,14;
163,21,9,17,119,34,164,50,138,17,117,23,45,27,156,332,20,6,20,15,6,410,70,15,44,21,16,23,24,13;
54,510,113,387,156,255,45,449,42,22,33,42,147,94,334,2626,111,157,286,213,46,103,1911,51,1923,47,8,87,17,687;
48,137,126,260,50,153,22,305,25,17,37,64,51,188,117,1701,84,42,104,169,51,76,607,50,1084,84,13,184,13,677;
27,86,39,98,30,60,17,114,14,10,25,35,30,78,71,629,31,38,69,62,19,47,349,25,425,38,10,83,18,212;
98,258,106,263,85,174,27,309,31,19,57,128,79,431,211,1798,92,88,196,164,40,142,1153,46,1237,172,10,417,18,588;
11,16,22,32,14,22,19,33,15,17,18,5,12,9,15,159,12,13,9,30,7,23,20,17,91,10,12,13,17,73;
22,22,19,39,22,25,19,37,16,14,9,12,14,11,31,182,13,13,16,27,10,38,67,15,110,8,9,15,9,70;
12,41,17,34,19,20,10,29,13,14,16,14,19,9,29,131,11,13,24,19,7,20,97,10,97,13,8,10,6,41;
31,38,19,35,32,38,33,45,27,10,19,11,19,15,42,221,23,17,17,27,13,56,109,14,142,12,5,10,15,71;
142,542,32,66,63,66,383,85,376,1407,91,627,46,612,161,498,37,32,127,95,22,253,636,28,1153,1076,194,587,25,117;
168,561,29,54,58,62,425,80,422,1564,102,690,33,659,160,418,33,24,120,93,21,287,537,25,1155,1184,210,643,24,111;
870,184,19,51,62,190,95,73,85,204,476,1568,44,5380,731,413,97,40,791,37,91,1188,3377,56,412,2161,34,5207,114,36;
172,565,33,65,74,66,458,89,442,1603,104,685,30,617,169,522,46,17,113,100,24,316,509,18,1215,1182,213,593,25,147;
41,21,30,48,31,39,44,60,42,14,31,13,13,10,34,320,20,7,13,39,14,98,26,21,158,18,7,9,11,130;
33,34,23,50,31,31,38,56,28,14,23,21,20,37,41,301,21,16,24,32,19,62,98,20,180,22,5,35,12,108;
41,29,54,96,43,64,49,121,38,10,32,17,25,16,56,683,42,17,20,69,27,95,94,33,373,15,16,10,12,287;
42,30,23,43,35,29,42,52,38,18,32,13,22,22,40,296,21,18,22,28,15,88,72,15,166,21,16,21,11,107;
108,17,20,22,75,34,95,46,84,21,77,32,27,83,92,269,19,9,26,18,12,253,56,19,71,53,12,84,22,52;
117,25,12,25,87,32,103,47,102,16,89,23,35,57,107,270,18,17,27,11,10,270,97,21,72,29,13,60,22,30;
138,20,15,25,84,43,107,56,96,10,95,78,26,245,130,315,16,15,43,20,22,316,176,15,88,103,14,235,25,55;
227,45,11,19,165,47,230,85,205,60,163,38,55,64,204,491,28,16,24,20,6,568,104,23,102,59,19,58,32,29;
177,12,11,12,132,30,173,51,156,13,120,12,46,10,152,338,20,15,9,10,13,440,17,24,22,17,10,9,24,17;
61,27,8,18,45,26,56,24,46,13,51,23,24,51,60,137,15,12,27,19,12,142,75,10,51,27,12,42,16,10;
104,28,15,30,78,38,104,58,85,20,75,22,34,50,106,298,24,15,23,23,11,251,106,11,94,28,6,58,16,42;
378,34,9,27,278,70,366,114,323,15,262,23,85,70,342,783,36,21,34,10,5,962,144,22,85,32,16,68,48,16;
57,743,55,346,228,240,65,405,51,9,42,19,214,22,477,2382,86,222,407,153,20,145,2752,26,1986,18,6,23,14,272;
63,123,54,133,64,94,59,163,51,8,48,22,52,47,118,954,44,42,74,87,32,134,464,28,617,31,16,50,12,297;
12,60,30,67,25,43,11,82,7,17,12,12,25,33,43,393,30,23,41,39,15,11,211,23,273,21,13,22,8,138;
77,426,39,211,154,152,65,251,57,10,50,23,132,69,306,1471,58,127,240,97,19,162,1603,29,1171,34,9,58,22,191;
16,13,14,24,16,19,16,31,14,5,16,4,12,10,21,124,17,6,10,15,14,31,25,12,63,9,14,8,12,51;
31,16,20,23,24,23,25,36,25,9,29,26,18,40,31,160,18,22,25,23,20,60,59,11,85,20,11,38,10,55;
15,14,11,13,8,14,11,17,19,14,13,12,9,6,20,86,10,4,8,15,5,20,24,7,53,15,6,8,6,38;
60,13,17,17,46,23,64,37,55,12,52,13,23,26,61,182,17,12,17,21,20,154,53,14,54,24,7,24,19,39;
682,78,16,49,56,144,53,63,48,9,377,1158,38,4126,560,323,78,30,593,25,68,940,2511,46,200,1575,13,3995,85,46;
795,171,18,36,51,163,130,60,118,339,437,1478,28,4889,642,296,92,25,692,34,82,1092,2894,56,378,2061,48,4737,98,45;
1234,108,12,53,55,256,48,60,35,7,670,2195,42,7836,1001,312,135,41,1106,22,123,1643,4670,84,241,2985,9,7597,147,17;
578,196,12,38,66,121,184,57,170,460,327,1070,38,3283,471,316,62,22,478,39,63,841,1967,43,418,1521,73,3179,73,39;
20,28,21,40,28,31,30,47,23,22,22,10,11,17,31,231,18,15,17,29,18,52,48,13,125,23,11,16,16,82;
21,24,13,20,21,16,26,27,23,21,20,18,15,31,31,131,10,12,22,14,10,47,68,14,83,16,8,28,14,39;
17,24,23,49,23,27,17,47,17,17,17,14,12,18,24,270,19,16,14,34,15,29,58,20,162,23,12,21,10,121;
25,32,10,35,23,24,34,38,24,18,20,17,16,17,35,189,17,17,24,22,14,57,101,19,120,16,9,23,17,54;
94,15,11,20,57,27,67,40,64,8,59,44,21,124,79,190,20,5,23,10,10,204,91,15,49,54,10,117,16,30;
75,22,11,11,60,26,66,32,66,15,55,29,24,58,81,180,18,12,27,15,3,183,96,11,63,31,14,53,18,22;
62,38,9,25,43,24,52,32,49,11,43,37,24,115,75,189,18,20,37,13,17,131,166,14,91,55,13,112,13,30;
83,43,14,15,56,30,80,37,68,30,58,28,21,48,83,200,11,12,27,13,9,175,107,15,79,37,13,44,15,15;
66,18,9,11,51,21,55,24,55,10,47,14,24,10,58,134,16,11,9,8,7,147,32,13,27,13,6,13,9,20;
49,16,9,8,38,14,43,21,39,11,37,17,17,16,42,85,17,14,15,9,7,110,17,11,16,13,7,21,13,13;
39,54,11,34,38,31,37,43,30,14,31,17,23,19,54,190,17,28,36,17,9,77,158,13,131,19,10,19,10,31;
144,36,8,19,99,27,136,46,121,32,103,23,36,50,131,288,20,14,21,18,7,342,80,13,55,32,13,43,24,9;
122,503,65,285,211,199,114,347,105,13,83,15,164,26,387,2073,81,155,283,145,21,292,1871,35,1531,26,18,24,18,345;
27,308,71,232,97,153,29,268,25,25,18,20,87,27,193,1531,63,92,170,128,29,51,1115,36,1140,29,16,31,6,403;
12,92,27,65,30,44,10,71,10,8,17,12,34,15,63,403,26,36,60,37,12,17,336,21,313,16,9,18,9,101;
188,830,64,404,344,300,186,499,162,26,132,25,259,50,630,2990,110,254,451,182,31,473,3086,42,2295,34,17,45,27,351;
32,26,14,24,26,20,25,28,25,20,20,15,12,13,35,136,12,9,19,19,11,52,69,15,79,14,10,9,12,42;
27,39,20,34,26,28,23,49,26,9,20,9,17,12,38,210,17,21,25,20,11,50,130,17,137,10,8,16,11,59;
10,14,13,13,13,20,15,20,8,6,12,10,8,10,15,59,6,6,22,18,6,23,32,14,39,7,9,5,14,25;
47,34,19,25,41,26,46,41,41,16,31,11,25,17,54,190,12,12,24,16,11,100,98,13,94,13,7,18,6,37;
115,2241,10,42,52,49,1612,61,1607,6685,79,2295,37,540,133,305,25,35,122,261,21,178,580,18,4227,4179,881,523,19,43;
130,3091,16,58,64,57,2237,70,2242,9295,77,3109,38,472,149,403,32,31,111,363,22,223,551,18,5821,5698,1212,457,22,67;
376,758,15,41,50,96,522,50,521,2088,212,1318,32,2295,332,243,48,38,355,91,41,517,1560,30,1437,2117,278,2226,53,19;
92,1007,19,32,41,37,753,49,750,3015,55,1062,20,316,92,257,16,13,66,134,13,155,267,18,1936,1915,402,309,22,70;
179,89,20,59,150,61,178,104,158,16,127,22,66,27,195,645,35,31,51,32,9,446,293,20,267,27,7,27,23,82;
20,28,29,25,20,24,28,35,20,20,16,13,13,15,34,154,16,15,19,22,8,43,82,17,100,14,5,12,15,51;
112,16,20,40,89,46,110,70,104,7,88,11,30,15,108,407,24,16,15,32,15,285,54,24,129,10,14,9,22,87;
127,62,9,42,104,45,124,75,110,29,83,21,40,26,138,429,21,28,40,24,10,293,196,19,184,32,16,31,25,52;
104,47,13,17,70,33,109,43,101,69,75,50,27,74,99,249,24,11,28,14,15,255,92,18,93,67,18,75,22,25;
103,56,9,23,80,30,94,48,87,25,77,32,41,52,120,284,15,23,38,15,6,248,190,16,122,39,9,54,24,20;
79,36,14,15,54,25,70,39,57,18,64,40,26,113,80,201,19,17,39,13,9,183,140,17,79,52,11,95,12,29;
257,42,9,19,195,45,253,86,229,31,189,33,61,87,243,540,29,19,27,18,11,665,129,19,83,55,11,93,34,13;
436,13,13,15,312,67,416,123,367,13,295,19,90,17,374,830,37,10,12,10,10,1097,28,27,24,10,12,13,55,16;
69,24,16,18,49,23,62,28,54,8,44,17,19,16,64,155,11,16,22,16,19,155,68,15,44,14,8,23,21,17;
80,21,12,22,61,27,78,43,66,12,57,15,22,21,81,205,23,11,14,17,11,193,51,13,56,16,12,26,17,34;
422,45,10,19,312,79,408,129,353,15,306,23,96,59,388,876,39,13,35,12,6,1073,161,27,94,24,10,51,53,11
];

% Normalize each column to sum to 1
data = bsxfun(@rdivide, data, sum(data));

%% Generate Cost Matrix M
x = linspace(0, 1, mutations);  % Adjust to the appropriate number of rows
M = abs(bsxfun(@minus, x', x));
M = M / median(M(:));  % Normalize M by its median

%% Parameters for Wasserstein Dictionary Learning
options.stop = 1e-3;
options.verbose = 2;
options.D_step_stop = 5e-5;
options.lambda_step_stop = 5e-4;
options.alpha = 0.5;
options.Kmultiplication = 'symmetric';
options.GPU = 0;


% Create legend labels
dictionaryLegendArray = cell(1, k);
for i = 1:k
    dictionaryLegendArray{i} = ['$d_{', num2str(i), '}$'];
end

gamma = 1 / 50;
wassersteinOrder = 1;
rho1 = 0.1;
rho2 = 0.1;

% Ensure dimensions of data and M are compatible
disp(['Size of data: ', mat2str(size(data))]);
disp(['Size of M: ', mat2str(size(M))]);

%% Perform Wasserstein Dictionary Learning
% Ensure data size matches what wasserstein_DL expects
[D, lambda, objectives] = wasserstein_DL(data, k, M .^ wassersteinOrder, gamma, rho1, rho2, options);

%% Visualization Parameters
minY = 0;
maxY = 0.1;
YtickStep = 0.02;
indices = 1:3;  % Change as needed based on your data
fontSize = 30;
lineWidth = 4;
axisValues = [0, 1, minY, maxY];  % Adjust to fit your data range

% Legend for data samples
dataLegendArray = cell(numel(indices), 1);
for i = 1:numel(indices)
    dataLegendArray{i} = ['$x_{', num2str(i), '}$'];
end

%% Visualize Data
plotDictionary(x, data(:, indices), axisValues, lineWidth, fontSize, YtickStep, 0, dataLegendArray, 'Data samples');

%% Compare Data and Reconstruction
width = 1200;
height = 600;
figure('Position', [1, 1, width, height]);

% Adjust axis values for comparison
axisValues(3) = 0;
minY = 0;
i = 1;  % Index of the data sample to compare

subplot(1, 2, 1);
plotDictionary(x, data(:, i), axisValues, lineWidth, fontSize, YtickStep, 0, 'x', 'Data');

subplot(1, 2, 2);
plotDictionary(x, [D * lambda(:, i), D * lambda(:, i)], axisValues, lineWidth, fontSize, YtickStep, 0, {'NMF reconstruction', 'DL reconstruction'}, 'Reconstruction');

%% Visualize Learned Matrices D and Lambda

% Visualize the learned dictionary D as a heatmap
figure;
subplot(1, 2, 1);
imagesc(D);  % Display matrix D as an image
colormap(parula);
colorbar;
title('Learned Dictionary Matrix D');
xlabel('Components');
ylabel('Data Dimensions');

% Visualize the coefficient matrix Lambda as a heatmap
subplot(1, 2, 2);
imagesc(lambda);  % Display matrix lambda as an image
colormap(parula);
colorbar;
title('Coefficient Matrix Lambda');
xlabel('Data Samples');
ylabel('Components');

% Optionally, you can also display individual components of D if needed:
figure;
for i = 1:size(D, 2)
    subplot(1, size(D, 2), i);
    plot(D(:, i));
    title(['Component ', num2str(i)]);
    xlabel('Dimensions');
    ylabel('Values');
end